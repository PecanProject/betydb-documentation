<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title></title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.12.1 and GitBook 2.6.7" />

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="betydb-tables.html">
<link rel="next" href="setting-up-a-centos-server.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="part"><span><b>I Overview</b></span></li>
<li class="chapter" data-level="1" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html"><i class="fa fa-check"></i><b>1</b> About BETYdb: Database Description and User’s Guide</a><ul>
<li class="chapter" data-level="1.1" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#objectives"><i class="fa fa-check"></i><b>1.1</b> Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#scope"><i class="fa fa-check"></i><b>1.2</b> Scope</a></li>
<li class="chapter" data-level="1.3" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#content"><i class="fa fa-check"></i><b>1.3</b> Content</a></li>
<li class="chapter" data-level="1.4" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#design"><i class="fa fa-check"></i><b>1.4</b> Design</a></li>
<li class="chapter" data-level="1.5" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#data-entry"><i class="fa fa-check"></i><b>1.5</b> Data Entry</a></li>
<li class="chapter" data-level="1.6" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#software"><i class="fa fa-check"></i><b>1.6</b> Software</a></li>
<li class="chapter" data-level="1.7" data-path="about-betydb-database-description-and-users-guide.html"><a href="about-betydb-database-description-and-users-guide.html#list-of-tables-in-the-bety-database"><i class="fa fa-check"></i><b>1.7</b> List of Tables in the BETY Database</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="betydb-tables.html"><a href="betydb-tables.html"><i class="fa fa-check"></i><b>2</b> BETYdb Tables</a><ul>
<li class="chapter" data-level="2.1" data-path="betydb-tables.html"><a href="betydb-tables.html#schema-enhanced-entity-relationship-model"><i class="fa fa-check"></i><b>2.1</b> Schema: Enhanced Entity-Relationship Model</a></li>
<li class="chapter" data-level="2.2" data-path="betydb-tables.html"><a href="betydb-tables.html#tables"><i class="fa fa-check"></i><b>2.2</b> Tables</a></li>
<li class="chapter" data-level="2.3" data-path="betydb-tables.html"><a href="betydb-tables.html#table-and-field-naming-conventions"><i class="fa fa-check"></i><b>2.3</b> Table and field naming conventions</a><ul>
<li class="chapter" data-level="2.3.1" data-path="betydb-tables.html"><a href="betydb-tables.html#data-tables"><i class="fa fa-check"></i><b>2.3.1</b> Data Tables</a></li>
<li class="chapter" data-level="2.3.2" data-path="betydb-tables.html"><a href="betydb-tables.html#auxillary-tables"><i class="fa fa-check"></i><b>2.3.2</b> Auxillary Tables</a></li>
<li class="chapter" data-level="2.3.3" data-path="betydb-tables.html"><a href="betydb-tables.html#join-tables"><i class="fa fa-check"></i><b>2.3.3</b> Join Tables</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Installing BETYdb</b></span></li>
<li class="chapter" data-level="3" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html"><i class="fa fa-check"></i><b>3</b> Deploying a Production Copy of the BETYdb Web Application</a><ul>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#installing-and-configuring-ruby-and-rails-code"><i class="fa fa-check"></i>Installing and Configuring Ruby and Rails Code</a><ul>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-1-log-in-to-the-deployment-machine-as-an-administrator"><i class="fa fa-check"></i>Step 1: Log in to the deployment machine as an administrator</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-2-add-a-new-user-as-the-owner-of-the-betydb-instance"><i class="fa fa-check"></i>Step 2: Add a new user as the owner of the BETYdb instance</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-3-choose-a-location-for-the-application-code"><i class="fa fa-check"></i>Step 3: Choose a location for the application code</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-4-create-the-target-parent-directory-and-clone-the-betydb-code-from-the-github-repository"><i class="fa fa-check"></i>Step 4: Create the target parent directory and clone the BETYdb code from the GitHub repository:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-5-if-you-have-not-already-done-so-install-the-correct-version-of-ruby"><i class="fa fa-check"></i>Step 5: If you have not already done so, install the correct version of Ruby</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-6-log-in-to-the-applications-user-account-and-make-sure-you-are-in-the-rails-root-directory"><i class="fa fa-check"></i>Step 6: Log in to the application’s user account and make sure you are in the Rails root directory:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-7-use-the-bundler-to-install-the-application-gems"><i class="fa fa-check"></i>Step 7: Use the Bundler to install the application Gems:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-8-create-a-database-configuration-file"><i class="fa fa-check"></i>Step 8: Create a database configuration file</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-9-create-a-rails-application-customization-file"><i class="fa fa-check"></i>Step 9: Create a Rails application customization file</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-10-compile-rails-assets"><i class="fa fa-check"></i>Step 10: Compile Rails assets:</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#loading-the-betydb-database"><i class="fa fa-check"></i>Loading the BETYdb Database</a><ul>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-11-download-the-load.bety.sh-script-from-the-pecan-repository"><i class="fa fa-check"></i>Step 11: Download the load.bety.sh script from the PEcAn repository:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-12-if-you-arent-already-there-cd-to-the-application-root-directory"><i class="fa fa-check"></i>Step 12: If you aren’t already there, cd to the application root directory:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-13-log-in-as-user-postgres"><i class="fa fa-check"></i>Step 13: Log in as user postgres:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-14-create-a-role-and-a-database-for-the-betydb-app"><i class="fa fa-check"></i>Step 14: Create a role and a database for the BETYdb app</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-15-run-the-load.bety.sh-script"><i class="fa fa-check"></i>Step 15: Run the load.bety.sh script:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-16-optional-load-data-from-another-machine"><i class="fa fa-check"></i>Step 16: (Optional) Load data from another machine:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-17-exit-the-postgres-user-account"><i class="fa fa-check"></i>Step 17: Exit the postgres user account:</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#complete-apache-and-passenger-configuration"><i class="fa fa-check"></i>Complete Apache and Passenger configuration</a><ul>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-18-check-that-the-correct-version-of-ruby-is-enabled"><i class="fa fa-check"></i>Step 18: Check that the correct version of Ruby is enabled:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-19-find-the-path-to-the-ruby-interpreter"><i class="fa fa-check"></i>Step 19: Find the path to the Ruby interpreter:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-20-configure-the-apache-server"><i class="fa fa-check"></i>Step 20: Configure the Apache Server</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-21-restart-apache"><i class="fa fa-check"></i>Step 21: Restart Apache:</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-22-test"><i class="fa fa-check"></i>Step 22: Test:</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#final-steps"><i class="fa fa-check"></i>Final Steps</a><ul>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-23-create-a-betydb-administrative-account"><i class="fa fa-check"></i>Step 23: Create a BETYdb administrative account</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-24-re-set-the-guest-user-account-password"><i class="fa fa-check"></i>Step 24: Re-Set the Guest user account password</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-25-ensure-images-for-priors-pages-are-generated"><i class="fa fa-check"></i>Step 25: Ensure images for Priors pages are generated</a></li>
<li class="chapter" data-level="" data-path="deploying-a-production-copy-of-the-betydb-web-application.html"><a href="deploying-a-production-copy-of-the-betydb-web-application.html#step-26-ensure-the-schemaspy-documentation-can-be-generated"><i class="fa fa-check"></i>Step 26: Ensure the SchemaSpy documentation can be generated</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html"><i class="fa fa-check"></i><b>4</b> Setting Up a CentOS Server</a><ul>
<li class="chapter" data-level="4.1" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#install-centos-7"><i class="fa fa-check"></i><b>4.1</b> Install CentOS 7</a></li>
<li class="chapter" data-level="4.2" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#install-additional-system-software"><i class="fa fa-check"></i><b>4.2</b> Install additional system software</a></li>
<li class="chapter" data-level="4.3" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#install-required-ruby-and-rails-softwareruby_with_rvm"><i class="fa fa-check"></i><b>4.3</b> Install required Ruby and Rails software</a><ul>
<li class="chapter" data-level="4.3.1" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#rvm-ruby-version-manager"><i class="fa fa-check"></i><b>4.3.1</b> RVM (Ruby Version Manager)</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#bundler"><i class="fa fa-check"></i><b>4.4</b> Bundler:</a></li>
<li class="chapter" data-level="4.5" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#node.js-needed-to-be-able-to-compile-rails-assets"><i class="fa fa-check"></i><b>4.5</b> node.js (needed to be able to compile Rails assets):</a></li>
<li class="chapter" data-level="4.6" data-path="setting-up-a-centos-server.html"><a href="setting-up-a-centos-server.html#phusion-passengerphusion_passenger"><i class="fa fa-check"></i><b>4.6</b> Phusion Passenger</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="configuring-postgresql.html"><a href="configuring-postgresql.html"><i class="fa fa-check"></i><b>5</b> Configuring PostgreSQL</a><ul>
<li class="chapter" data-level="5.1" data-path="configuring-postgresql.html"><a href="configuring-postgresql.html#step-1-initialize-the-database-cluster-and-start-the-server"><i class="fa fa-check"></i><b>5.1</b> Step 1: Initialize the database cluster and start the server</a></li>
<li class="chapter" data-level="5.2" data-path="configuring-postgresql.html"><a href="configuring-postgresql.html#step-2-enable-password-authentication-for-all-users-other-than-postgres"><i class="fa fa-check"></i><b>5.2</b> Step 2: Enable password authentication for all users other than postgres</a></li>
<li class="chapter" data-level="5.3" data-path="configuring-postgresql.html"><a href="configuring-postgresql.html#step-3-create-a-new-role-and-new-database-for-betydb"><i class="fa fa-check"></i><b>5.3</b> Step 3: Create a new role and new database for BETYdb</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html"><i class="fa fa-check"></i><b>6</b> Archived Setup Documentation</a><ul>
<li class="chapter" data-level="6.1" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#setting-up-a-redhat-or-centos-server"><i class="fa fa-check"></i><b>6.1</b> Setting up a RedHat or CentOS Server</a><ul>
<li class="chapter" data-level="6.1.1" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#overview"><i class="fa fa-check"></i><b>6.1.1</b> Overview</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#instructions-for-installing-and-configuring-postgresql"><i class="fa fa-check"></i><b>6.2</b> Instructions for Installing and Configuring PostgreSQL</a></li>
<li class="chapter" data-level="6.3" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#installing-the-betydb-rails-application"><i class="fa fa-check"></i><b>6.3</b> Installing the BETYdb Rails Application</a><ul>
<li class="chapter" data-level="6.3.1" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#prerequisites"><i class="fa fa-check"></i><b>6.3.1</b> Prerequisites</a></li>
<li class="chapter" data-level="6.3.2" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#installing-the-rails-application"><i class="fa fa-check"></i><b>6.3.2</b> Installing the Rails Application</a></li>
<li class="chapter" data-level="6.3.3" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#updating-syncing-the-database"><i class="fa fa-check"></i><b>6.3.3</b> Updating / Syncing the database</a></li>
<li class="chapter" data-level="6.3.4" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#starting-the-betydb-rails-web-application"><i class="fa fa-check"></i><b>6.3.4</b> Starting the BETYdb Rails Web Application</a></li>
<li class="chapter" data-level="6.3.5" data-path="archived-setup-documentation.html"><a href="archived-setup-documentation.html#logrotation"><i class="fa fa-check"></i><b>6.3.5</b> Logrotation</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III BETYdb System Administration</b></span></li>
<li class="chapter" data-level="7" data-path="updating-betydb-when-new-versions-are-released.html"><a href="updating-betydb-when-new-versions-are-released.html"><i class="fa fa-check"></i><b>7</b> Updating BETYdb When New Versions are Released</a><ul>
<li class="chapter" data-level="7.1" data-path="updating-betydb-when-new-versions-are-released.html"><a href="updating-betydb-when-new-versions-are-released.html#updating-the-bety-database"><i class="fa fa-check"></i><b>7.1</b> Updating the BETY database</a></li>
<li class="chapter" data-level="7.2" data-path="updating-betydb-when-new-versions-are-released.html"><a href="updating-betydb-when-new-versions-are-released.html#update-the-rails-app-and-schema"><i class="fa fa-check"></i><b>7.2</b> Update the Rails app and schema</a></li>
<li class="chapter" data-level="7.3" data-path="updating-betydb-when-new-versions-are-released.html"><a href="updating-betydb-when-new-versions-are-released.html#load-a-fresh-version-of-database"><i class="fa fa-check"></i><b>7.3</b> Load a fresh version of database</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html"><i class="fa fa-check"></i><b>8</b> Distributed instances of BETYdb</a><ul>
<li class="chapter" data-level="8.1" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#syncing-databases"><i class="fa fa-check"></i><b>8.1</b> Syncing Databases</a><ul>
<li class="chapter" data-level="8.1.1" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#exporting-data"><i class="fa fa-check"></i><b>8.1.1</b> Exporting Data</a></li>
<li class="chapter" data-level="8.1.2" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#importing-data"><i class="fa fa-check"></i><b>8.1.2</b> Importing Data</a></li>
<li class="chapter" data-level="8.1.3" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#primary-key-allocations"><i class="fa fa-check"></i><b>8.1.3</b> Primary Key Allocations</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#feedback-tab"><i class="fa fa-check"></i><b>8.2</b> Feedback Tab</a></li>
<li class="chapter" data-level="8.3" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#customization"><i class="fa fa-check"></i><b>8.3</b> Customization</a></li>
<li class="chapter" data-level="8.4" data-path="distributed-instances-of-betydb.html"><a href="distributed-instances-of-betydb.html#issues"><i class="fa fa-check"></i><b>8.4</b> Issues</a></li>
</ul></li>
<li class="part"><span><b>IV BETYdb Development</b></span></li>
<li class="chapter" data-level="9" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html"><i class="fa fa-check"></i><b>9</b> Ruby on Rails Application Overview (draft)</a><ul>
<li class="chapter" data-level="9.1" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#introduction-to-ruby-on-rails"><i class="fa fa-check"></i><b>9.1</b> Introduction to Ruby-on-Rails</a></li>
<li class="chapter" data-level="9.2" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#introduction-to-mvc"><i class="fa fa-check"></i><b>9.2</b> Introduction to MVC</a></li>
<li class="chapter" data-level="9.3" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#source-code-map"><i class="fa fa-check"></i><b>9.3</b> Source Code Map</a></li>
<li class="chapter" data-level="9.4" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#misc.-information"><i class="fa fa-check"></i><b>9.4</b> Misc. Information</a><ul>
<li class="chapter" data-level="9.4.1" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#providing-model-output-for-download"><i class="fa fa-check"></i><b>9.4.1</b> Providing model output for download</a></li>
<li class="chapter" data-level="9.4.2" data-path="ruby-on-rails-application-overview-draft.html"><a href="ruby-on-rails-application-overview-draft.html#related-issues-commits"><i class="fa fa-check"></i><b>9.4.2</b> Related Issues / Commits:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html"><i class="fa fa-check"></i><b>10</b> Ruby-on-Rails: Developing, Upgrading, and Deploying</a><ul>
<li class="chapter" data-level="10.1" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#development-and-testing"><i class="fa fa-check"></i><b>10.1</b> Development and Testing</a></li>
<li class="chapter" data-level="10.2" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#deploying-a-new-version"><i class="fa fa-check"></i><b>10.2</b> Deploying a new version:</a></li>
<li class="chapter" data-level="10.3" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#deploying-or-upgrading-to-a-new-version-of-the-betydb-rails-app"><i class="fa fa-check"></i><b>10.3</b> Deploying or upgrading to a new version of the BETYdb Rails app</a><ul>
<li class="chapter" data-level="10.3.1" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#running-migrations"><i class="fa fa-check"></i><b>10.3.1</b> Running Migrations</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#versioning-and-tagging"><i class="fa fa-check"></i><b>10.4</b> Versioning and Tagging</a><ul>
<li class="chapter" data-level="10.4.1" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#protocol-for-defining-and-releasing-versions"><i class="fa fa-check"></i><b>10.4.1</b> Protocol for defining and releasing versions</a></li>
<li class="chapter" data-level="10.4.2" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#version-numbering"><i class="fa fa-check"></i><b>10.4.2</b> Version Numbering</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="ruby-on-rails-developing-upgrading-and-deploying.html"><a href="ruby-on-rails-developing-upgrading-and-deploying.html#commenting-in-the-rails-models"><i class="fa fa-check"></i><b>10.5</b> Commenting in the Rails Models</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="automated-tests.html"><a href="automated-tests.html"><i class="fa fa-check"></i><b>11</b> Automated Tests</a><ul>
<li class="chapter" data-level="11.1" data-path="automated-tests.html"><a href="automated-tests.html#development-and-testing-1"><i class="fa fa-check"></i><b>11.1</b> Development and Testing</a></li>
<li class="chapter" data-level="11.2" data-path="automated-tests.html"><a href="automated-tests.html#running-the-rspec-tests-on-betydb."><i class="fa fa-check"></i><b>11.2</b> Running the RSpec tests on BETYdb.</a><ul>
<li class="chapter" data-level="11.2.1" data-path="automated-tests.html"><a href="automated-tests.html#preparing-the-test-database."><i class="fa fa-check"></i><b>11.2.1</b> Preparing the test database.</a></li>
<li class="chapter" data-level="11.2.2" data-path="automated-tests.html"><a href="automated-tests.html#running-the-tests"><i class="fa fa-check"></i><b>11.2.2</b> Running the tests</a></li>
<li class="chapter" data-level="11.2.3" data-path="automated-tests.html"><a href="automated-tests.html#troubleshooting"><i class="fa fa-check"></i><b>11.2.3</b> Troubleshooting</a></li>
<li class="chapter" data-level="11.2.4" data-path="automated-tests.html"><a href="automated-tests.html#creating-a-new-postgis-enabled-database-template"><i class="fa fa-check"></i><b>11.2.4</b> Creating a new PostGIS-enabled database template</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="code-style.html"><a href="code-style.html"><i class="fa fa-check"></i><b>12</b> Code Style</a><ul>
<li class="chapter" data-level="12.1" data-path="code-style.html"><a href="code-style.html#whitespace-conventions-in-the-betydb-code"><i class="fa fa-check"></i><b>12.1</b> Whitespace conventions in the BETYdb Code</a></li>
<li class="chapter" data-level="12.2" data-path="code-style.html"><a href="code-style.html#fixing-legacy-formatting"><i class="fa fa-check"></i><b>12.2</b> Fixing legacy formatting</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="complex-joins-in-the-web-interface.html"><a href="complex-joins-in-the-web-interface.html"><i class="fa fa-check"></i><b>13</b> Complex Joins in the Web Interface</a></li>
<li class="chapter" data-level="14" data-path="database-constraints.html"><a href="database-constraints.html"><i class="fa fa-check"></i><b>14</b> Database Constraints</a><ul>
<li class="chapter" data-level="14.1" data-path="database-constraints.html"><a href="database-constraints.html#types-of-constraints"><i class="fa fa-check"></i><b>14.1</b> Types of Constraints</a></li>
<li class="chapter" data-level="14.2" data-path="database-constraints.html"><a href="database-constraints.html#value-constraints-including-some-not-null-constraints"><i class="fa fa-check"></i><b>14.2</b> Value Constraints (including some NOT NULL constraints)</a><ul>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#global"><i class="fa fa-check"></i>Global</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#covariates-1"><i class="fa fa-check"></i>covariates:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#managements-1"><i class="fa fa-check"></i>managements:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#species"><i class="fa fa-check"></i>species:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#sites-1"><i class="fa fa-check"></i>sites:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#traits-1"><i class="fa fa-check"></i>traits:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#treatments-1"><i class="fa fa-check"></i>treatments:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#users"><i class="fa fa-check"></i>users:</a></li>
<li class="chapter" data-level="" data-path="database-constraints.html"><a href="database-constraints.html#yields-see-also-traits-constraints"><i class="fa fa-check"></i>yields: [see also traits constraints]</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="database-constraints.html"><a href="database-constraints.html#foreign-key-constraints"><i class="fa fa-check"></i><b>14.3</b> Foreign Key Constraints</a></li>
<li class="chapter" data-level="14.4" data-path="database-constraints.html"><a href="database-constraints.html#non-null-constraints"><i class="fa fa-check"></i><b>14.4</b> Non Null Constraints</a></li>
<li class="chapter" data-level="14.5" data-path="database-constraints.html"><a href="database-constraints.html#uniqueness-constraints"><i class="fa fa-check"></i><b>14.5</b> Uniqueness constraints</a></li>
<li class="chapter" data-level="14.6" data-path="database-constraints.html"><a href="database-constraints.html#technical-note"><i class="fa fa-check"></i><b>14.6</b> Technical Note</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="modifying-the-betydb-schema.html"><a href="modifying-the-betydb-schema.html"><i class="fa fa-check"></i><b>15</b> Modifying the BETYdb schema</a><ul>
<li class="chapter" data-level="15.1" data-path="modifying-the-betydb-schema.html"><a href="modifying-the-betydb-schema.html#modifying-bety-troubleshooting"><i class="fa fa-check"></i><b>15.1</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html"><i class="fa fa-check"></i><b>16</b> Issuing a New Release</a><ul>
<li class="chapter" data-level="16.1" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html#writing-release-notes"><i class="fa fa-check"></i><b>16.1</b> Writing release notes</a></li>
<li class="chapter" data-level="16.2" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html#upgrading-the-canonical-betydb-rails-sitecanonical_site"><i class="fa fa-check"></i><b>16.2</b> Upgrading the canonical BETYdb Rails site</a></li>
<li class="chapter" data-level="16.3" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html#upgrading-other-production-sites"><i class="fa fa-check"></i><b>16.3</b> Upgrading other production sites</a></li>
<li class="chapter" data-level="16.4" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html#finishing-the-release"><i class="fa fa-check"></i><b>16.4</b> Finishing the release</a><ul>
<li class="chapter" data-level="16.4.1" data-path="issuing-a-new-release.html"><a href="issuing-a-new-release.html#version-numbering-1"><i class="fa fa-check"></i><b>16.4.1</b> Version Numbering</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Appendix</b></span></li>
<li class="chapter" data-level="" data-path="release-notes-template.html"><a href="release-notes-template.html"><i class="fa fa-check"></i>Release Notes Template</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="deploying-a-production-copy-of-the-betydb-web-application" class="section level1">
<h1><span class="header-section-number">3</span> Deploying a Production Copy of the BETYdb Web Application</h1>
<p>These instructions are specifically tailored to the task of setting up a new instance of BETYdb on a CentOS 7 machine. We assume the following are installed:</p>
<ol style="list-style-type: decimal">
<li>Ruby Version Manager (RVM).</li>
<li>Bundler</li>
<li>Phusion Passenger</li>
<li>Apache 2.2 or greater.</li>
<li>PostgreSQL 9.4 or greater.</li>
<li>PostGIS 2.1.0 or greater.</li>
<li>Git 1.8.2.1 or greater.</li>
<li>R 3.1.0 or greater.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></li>
<li>Graphviz dot version 2.2.1 or a version greater than 2.4.</li>
<li>Java 1.8 or greater.</li>
<li>nodejs and npm</li>
<li>curl</li>
<li>Your preferred editor.</li>
</ol>
<p>In addition, we assume:</p>
<ol style="list-style-type: decimal">
<li>You have an account on the machine, and that account has sudo access.</li>
<li>The PostgreSQL server is running and there is a machine user account called <code>postgres</code> with password-less (<em>peer</em>) access to all PostgreSQL databases.</li>
<li>PostgreSQL has been configured so that all non-postgres database roles can log in to the PostgreSQL server using a password, both using a UNIX domain socket connection and using a connection to <code>localhost</code> over TCP/IP.</li>
</ol>
<p>Information about installing CentOS, adding users, installing the requisite software, and setting up and starting the PostgreSQL server is contained in various subsections below.</p>
<p><strong>IMPORTANT! In what follows, we use the following placeholder names to represent names that will vary with the installation:</strong></p>
<ul>
<li>Operating system accounts:
<ul>
<li><strong><code>&lt;adminuser&gt;</code> — the operating system account name for a user with complete sudo access</strong></li>
<li><strong><code>&lt;betyappuser&gt;</code> — the operating system account name for the user that will own this BETY app instance; generally, <code>&lt;betyappuser&gt;</code> should equal <code>&lt;betyapp&gt;</code>, but we distinguish them here for clarity</strong></li>
</ul></li>
<li>Path names:
<ul>
<li><strong><code>&lt;betyapp&gt;</code> — the name of the parent directory of the Rails root directory for the BETY app instance</strong></li>
</ul></li>
<li>Database-related names:
<ul>
<li><strong><code>&lt;betydb&gt;</code> — the name of the database this instance of the BETY app will use</strong></li>
<li><strong><code>&lt;dbuser&gt;</code> — the owner of database <code>&lt;betydb&gt;</code></strong></li>
<li><strong><code>&lt;dbpw&gt;</code> — the password for database user <code>&lt;dbuser&gt;</code></strong></li>
</ul></li>
</ul>
<p>For convenience, we generally leave off the angle brackets below as if these are the actual names that we will be using. In practice, sometimes the same name will be used for several of these; for example, often <code>&lt;betyappuser&gt;</code>, <code>&lt;betyapp&gt;</code>, <code>&lt;betydb&gt;</code>, <code>&lt;dbuser&gt;</code>, and <code>&lt;dbpw&gt;</code> will all be “bety”.</p>
<div id="installing-and-configuring-ruby-and-rails-code" class="section level2 unnumbered">
<h2>Installing and Configuring Ruby and Rails Code</h2>
<div id="step-1-log-in-to-the-deployment-machine-as-an-administrator" class="section level3 unnumbered">
<h3>Step 1: Log in to the deployment machine as an administrator</h3>
<p>This is the account we refer to as <code>&lt;adminuser&gt;</code> above. This user will need to have sudo permissions to do such tasks as adding a new user, deploying the BETYdb code base, editing the HTTPD configuration files, and starting and restarting the Web server.</p>
</div>
<div id="step-2-add-a-new-user-as-the-owner-of-the-betydb-instance" class="section level3 unnumbered">
<h3>Step 2: Add a new user as the owner of the BETYdb instance</h3>
<p>It is recommended that each Rails app be run under its own user account. Use the following command to create the user:<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<pre><code>sudo useradd &lt;betyappuser&gt;</code></pre>
<p>Also, you may want to ensure this user has your SSH key installed:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> mkdir -p ~betyappuser/.ssh
<span class="fu">touch</span> <span class="va">$HOME</span>/.ssh/authorized_keys
<span class="fu">sudo</span> sh -c <span class="st">&quot;cat </span><span class="va">$HOME</span><span class="st">/.ssh/authorized_keys &gt;&gt; ~betyappuser/.ssh/authorized_keys&quot;</span>
<span class="fu">sudo</span> chown -R betyappuser: ~betyappuser/.ssh
<span class="fu">sudo</span> chmod 700 ~betyappuser/.ssh
<span class="fu">sudo</span> sh -c <span class="st">&quot;chmod 600 ~betyappuser/.ssh/*&quot;</span></code></pre></div>
</div>
<div id="step-3-choose-a-location-for-the-application-code" class="section level3 unnumbered">
<h3>Step 3: Choose a location for the application code</h3>
<p>In this example, we’ll choose <code>/var/www/betyapp</code> as the parent directory for the Rails root directory, which we’ll call <code>code</code>.</p>
</div>
<div id="step-4-create-the-target-parent-directory-and-clone-the-betydb-code-from-the-github-repository" class="section level3 unnumbered">
<h3>Step 4: Create the target parent directory and clone the BETYdb code from the GitHub repository:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> mkdir -p /var/www/betyapp
<span class="fu">sudo</span> chown betyappuser: /var/www/betyapp
<span class="bu">cd</span> /var/www/betyapp
<span class="fu">sudo</span> -u betyappuser -H git clone https://github.com/PecanProject/bety.git code</code></pre></div>
</div>
<div id="step-5-if-you-have-not-already-done-so-install-the-correct-version-of-ruby" class="section level3 unnumbered">
<h3>Step 5: If you have not already done so, install the correct version of Ruby</h3>
<p>First cd to the Rails root directory:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> /var/www/betyapp/code</code></pre></div>
<p>If you haven’t installed any versions of Ruby using the Ruby Version Manager, you should get a warning that the required version of Ruby is not installed along with the command to run to install it. Go ahead and install this version. This command should have the form</p>
<pre><code>rvm install &quot;ruby-X.X.X&quot;</code></pre>
<p>where “ruby-X.X.X” matches the contents of the file <code>.ruby-version</code>.</p>
<p>You can use</p>
<pre><code>rvm list</code></pre>
<p>to check that you have the correct version of Ruby installed, and</p>
<pre><code>rvm current</code></pre>
<p>to check that you have the correct version activated.</p>
<p><em>The next several steps should be run as the app’s user (<code>&lt;betyappuser&gt;</code>).</em></p>
</div>
<div id="step-6-log-in-to-the-applications-user-account-and-make-sure-you-are-in-the-rails-root-directory" class="section level3 unnumbered">
<h3>Step 6: Log in to the application’s user account and make sure you are in the Rails root directory:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -u betyappuser -H bash -l
<span class="bu">cd</span> /var/www/betyapp/code</code></pre></div>
<p>You may get error about not being able to create a gemset, which you may ignore, but you should check that the correct version of Ruby is active:</p>
<pre><code>rvm current</code></pre>
</div>
<div id="step-7-use-the-bundler-to-install-the-application-gems" class="section level3 unnumbered">
<h3>Step 7: Use the Bundler to install the application Gems:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> install --deployment --without development test javascript_testing debug</code></pre></div>
<p>If the bundler fails to install the “pg” Gem, use the “bundle config” command to add an option as follows and then re-run the bundle install command:<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> config --local build.pg --with-pg-config=/usr/pgsql-9.4/bin/pg_config
<span class="ex">bundle</span> install</code></pre></div>
</div>
<div id="step-8-create-a-database-configuration-file" class="section level3 unnumbered">
<h3>Step 8: Create a database configuration file</h3>
<p>To do this from the command line, just run</p>
<pre><code>cat &gt; config/database.yml &lt;&lt; EOF
production:
  adapter: postgis
  encoding: utf-8
  reconnect: false
  database: &lt;betydb&gt;
  pool: 5
  username: &lt;dbuser&gt;
  password: &lt;dbpw&gt;
EOF</code></pre>
<p>replacing the placeholders <code>&lt;betydb&gt;</code>, <code>&lt;dbuser&gt;</code>, and <code>&lt;dbpw&gt;</code> with whatever identifiers you chose to user for these entities.</p>
</div>
<div id="step-9-create-a-rails-application-customization-file" class="section level3 unnumbered">
<h3>Step 9: Create a Rails application customization file</h3>
<p>The most important purpose of this file is to override the default site key so that your site will be more secure.</p>
<p>First, generate a secret key using the command</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> exec rake secret</code></pre></div>
<p>Then run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">cat</span> <span class="op">&gt;</span> config/application.yml <span class="op">&lt;&lt; EOF</span>
production:
  rest_auth_site_key: &#39;&lt;secret key&gt;&#39;
EOF</code></pre></div>
<p>where <code>&lt;secret key&gt;</code> is the result of the <code>rake secret</code> command.</p>
<p>This is a minimal application configuration file. There are many other settings that may be used to customize the appearance of your site. See the sample file <code>config/application.yml.template</code> for details. At the very least, it is highly recommended to set the contact information appropriate for your site.</p>
<p>Below, we show how to modify this file to enable the SchemaSpy documentation generator.</p>
</div>
<div id="step-10-compile-rails-assets" class="section level3 unnumbered">
<h3>Step 10: Compile Rails assets:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> exec rake assets:precompile RAILS_ENV=production</code></pre></div>
<p><strong>Important!</strong> If you are planning to deploy the BETYdb app to a sub-URI of your server name—to <code>yourserver.com/suburi</code>, say, instead of <code>yourserver.com</code>—then you need to set the RAILS_RELATIVE_URL_ROOT variable when precompiling:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> exec rake assets:precompile RAILS_ENV=production RAILS_RELATIVE_URL_ROOT=/suburi</code></pre></div>
</div>
</div>
<div id="loading-the-betydb-database" class="section level2 unnumbered">
<h2>Loading the BETYdb Database</h2>
<p><em>For this first step you should still be logged in as <code>&lt;betyappuser&gt;</code> and still be in the <code>/var/www/betyapp/code</code> directory.</em></p>
<div id="step-11-download-the-load.bety.sh-script-from-the-pecan-repository" class="section level3 unnumbered">
<h3>Step 11: Download the load.bety.sh script from the PEcAn repository:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">curl</span> https://raw.githubusercontent.com/PecanProject/pecan/develop/scripts/load.bety.sh <span class="op">&gt;</span> script/load.bety.sh
<span class="fu">chmod</span> +x script/load.bety.sh</code></pre></div>
<p>Now exit the <code>&lt;betyappuser&gt;</code> account:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">exit</span></code></pre></div>
<p>You should now be back to the administrator account <code>&lt;adminuser&gt;</code> that you originally logged in to.</p>
</div>
<div id="step-12-if-you-arent-already-there-cd-to-the-application-root-directory" class="section level3 unnumbered">
<h3>Step 12: If you aren’t already there, cd to the application root directory:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> /var/www/betyapp/code</code></pre></div>
</div>
<div id="step-13-log-in-as-user-postgres" class="section level3 unnumbered">
<h3>Step 13: Log in as user postgres:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> su postgres</code></pre></div>
</div>
<div id="step-14-create-a-role-and-a-database-for-the-betydb-app" class="section level3 unnumbered">
<h3>Step 14: Create a role and a database for the BETYdb app</h3>
<p>First start psql:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">psql</span></code></pre></div>
<p>Now run the <code>CREATE ROLE</code> and <code>CREATE DATABASE</code> commands in psql:</p>
<pre><code>CREATE ROLE dbuser WITH LOGIN CREATEDB NOSUPERUSER NOCREATEROLE PASSWORD &#39;dbpw&#39;;
CREATE DATABASE betydb WITH OWNER dbuser;
\q</code></pre>
</div>
<div id="step-15-run-the-load.bety.sh-script" class="section level3 unnumbered">
<h3>Step 15: Run the load.bety.sh script:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">script/load.bety.sh</span> -a postgres -c -d betydb -e -g -m <span class="op">&lt;</span>localdb id number<span class="op">&gt;</span> -o dbuser -r 0</code></pre></div>
<p>Here, <code>&lt;localdb id number&gt;</code> is some integer that is unique to each database. See <a href="distributed-instances-of-betydb.html#distributed-instances-of-betydb">Distributed instances of BETYdb</a> for further information.</p>
<p>This will create the tables, views, indices, constraints, and functions required for BETYdb, replicating the database schema found on machine 0, the Energy Biosciences Institute server for BETYdb, whose BETYdb database schema is considered the “canonical” or “official” schema.<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> (Other machines may have a slightly modified schema, so it is important to use the creation (<code>-c</code>) option only when the remote machine is machine 0.) The tables will all be empty except for the following: <code>formats</code>, <code>machines</code>, <code>mimetypes</code>, <code>schema_migrations</code>, <code>spacial_ref_sys</code>, and <code>users</code>. A guest user account (“guestuser”) will be added to the users table.</p>
<p>This machine’s database contains the most extensive metadata, so you may want load the <em>data</em> from this machine, not just the database schema. To do so, run the above command without the “-e” option.</p>
</div>
<div id="step-16-optional-load-data-from-another-machine" class="section level3 unnumbered">
<h3>Step 16: (Optional) Load data from another machine:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">script/load.bety.sh</span> -a postgres -d betydb -m <span class="op">&lt;</span>localdb id number<span class="op">&gt;</span> -o dbuser -r <span class="op">&lt;</span>remotedb id number<span class="op">&gt;</span></code></pre></div>
<p>This may be executed multiple times with different remote database id numbers. Again, consult <a href="distributed-instances-of-betydb.html#distributed-instances-of-betydb">Distributed instances of BETYdb</a> to see what data sources are available.</p>
<p>(If you used the <code>-e</code> option in the previous step but then decided you want the full data from machine 0 after all, you can chose <code>&lt;remotedb id number&gt;</code>=0.)</p>
</div>
<div id="step-17-exit-the-postgres-user-account" class="section level3 unnumbered">
<h3>Step 17: Exit the postgres user account:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">exit</span></code></pre></div>
<p>You should now once again be in the administrative account (<code>&lt;adminuser&gt;</code>) and in the BETYdb app’s root directory, <code>/var/www/betyapp/code</code>.</p>
</div>
</div>
<div id="complete-apache-and-passenger-configuration" class="section level2 unnumbered">
<h2>Complete Apache and Passenger configuration</h2>
<div id="step-18-check-that-the-correct-version-of-ruby-is-enabled" class="section level3 unnumbered">
<h3>Step 18: Check that the correct version of Ruby is enabled:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">rvm</span> current</code></pre></div>
<p>This should be the version listed in the file .ruby-version</p>
</div>
<div id="step-19-find-the-path-to-the-ruby-interpreter" class="section level3 unnumbered">
<h3>Step 19: Find the path to the Ruby interpreter:</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">passenger-config</span> about ruby-command</code></pre></div>
<p>Use the location given in the resulting output as the value of <code>path-to-ruby</code> in the next step.</p>
</div>
<div id="step-20-configure-the-apache-server" class="section level3 unnumbered">
<h3>Step 20: Configure the Apache Server</h3>
<p>Create a new Apache configuration file (call it, say, <code>bety.conf</code>) in the configuration directory <code>/usr/httpd/conf.d</code> and open it in an editor. Add the following contents to the file: <a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a></p>
<pre><code>  &lt;VirtualHost *:80&gt;
      ServerName yourserver.com

      # Tell Apache and Passenger where your app&#39;s &#39;public&#39; directory is
      DocumentRoot /var/www/betyapp/code/public

      PassengerRuby /path-to-ruby

      # Relax Apache security settings
      &lt;Directory /var/www/betyapp/code/public&gt;
        Allow from all
        Options -MultiViews

        SetEnv SECRET_KEY_BASE &lt;secret key&gt;
        # (Alternatively, put &quot;export SECRET_KEY_BASE=&lt;secret key&gt;&quot; in the
          .bash_profile file for user &lt;betyappuser&gt;.)

        # Uncomment this if you&#39;re on Apache &gt;= 2.4:
        #Require all granted
      &lt;/Directory&gt;
  &lt;/VirtualHost&gt;</code></pre>
<p>Here, replace <code>yourserver.com</code> with your server’s host name and replace <code>/path-to-bety</code> with the path found above using the <code>passenger-config</code> command.</p>
<p>Also, replace <code>&lt;secret key&gt;</code> with some long, random word. You can generate a suitable value using the command</p>
<pre><code>  bundle exec rake secret</code></pre>
<p>(As noted in the comment, this setting can be put in the environment of <code>&lt;betyappuser&gt;</code> instead of here in the server configuration file.)</p>
<p>Note: If you want your app to be served at a sub-URI of your server name, say, <code>yourserver.com/suburi</code>, use the following configuration instead:</p>
<pre><code>  &lt;VirtualHost *:80&gt;
      ServerName yourserver.com
      
      PassengerRuby /path-to-ruby

      Alias /suburi /var/www/betyapp/code/public
      &lt;Location /suburi&gt;
          PassengerBaseURI /suburi
          PassengerAppRoot /var/www/betyapp/code
      &lt;/Location&gt;
      &lt;Directory /var/www/betyapp/code/public&gt;
          Allow from all
          Options -MultiViews

          SetEnv SECRET_KEY_BASE &lt;secret key&gt;

          # Uncomment this if you&#39;re on Apache &gt;= 2.4:
          #Require all granted
      &lt;/Directory&gt;
  &lt;/VirtualHost&gt;</code></pre>
</div>
<div id="step-21-restart-apache" class="section level3 unnumbered">
<h3>Step 21: Restart Apache:</h3>
<pre><code>  sudo apachectl restart</code></pre>
</div>
<div id="step-22-test" class="section level3 unnumbered">
<h3>Step 22: Test:</h3>
<pre><code>  curl yourserver.com</code></pre>
<p>or, if you deployed to a suburi,</p>
<pre><code>  curl yourserver.com/suburi</code></pre>
<p>Alternatively, try visiting the URL in a browser.</p>
</div>
</div>
<div id="final-steps" class="section level2 unnumbered">
<h2>Final Steps</h2>
<div id="step-23-create-a-betydb-administrative-account" class="section level3 unnumbered">
<h3>Step 23: Create a BETYdb administrative account</h3>
<p>In a browser, visit the home page of your new BETYdb site and click the “Register for BETYdb” button. Fill out the form; at a minimum, you must supply values for “Login”, “Email”, “Password”, and “Confirm Password” and click the “I’m not a robot” checkbox. It is highly recommended to fill out the “Name” field as well since this is the name that will be displayed when you are logged in as the new user. Note that you cannot re-use a previously used login or e-mail address.</p>
<p>After completing the form, click “Sign Up”. You should see the “Thanks for signing up!” message.</p>
<p>Once you have created a user, give that user full access privileges. To do this, use psql:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">psql</span> -U <span class="op">&lt;</span>dbuser<span class="op">&gt;</span> <span class="op">&lt;</span>betydb<span class="op">&gt;</span></code></pre></div>
<p>Once psql has started, if the login of the user you wish to alter is “admin”, run these commands in the psql session:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">UPDATE</span> users <span class="kw">SET</span> access_level = <span class="dv">1</span>, page_access_level = <span class="dv">1</span> <span class="kw">WHERE</span> login = <span class="st">&#39;admin&#39;</span>;
\q</code></pre></div>
</div>
<div id="step-24-re-set-the-guest-user-account-password" class="section level3 unnumbered">
<h3>Step 24: Re-Set the Guest user account password</h3>
<p>The Guest User account password will not be set correctly unless you use ‘thisisnotasecret’ as the site key. But for security reasons, you shouldn’t use this as a site key on a production server (which was the reason for overriding the value of <code>rest_auth_site_key</code> in the customization file <code>config/application.yml</code>). So you need to reset the Guest User account’s password to get it to work again.</p>
<p>Log in to BETYdb as the administrative user you created in the previous step and go to the Users list (menu item <code>Data/Users</code>). Search for “guestuser” and click the edit button for that user. Check the “change password” checkbox and then enter “guestuser” in both password fields; then click the “Update” button.</p>
<p>Now log out and try the “Log in as Guest” button to make sure that it works.</p>
</div>
<div id="step-25-ensure-images-for-priors-pages-are-generated" class="section level3 unnumbered">
<h3>Step 25: Ensure images for Priors pages are generated</h3>
<p>BETYdb uses <code>R</code> to generate images for the Priors pages on the fly if they don’t already exist. In order for this to work, the <code>ggplot2</code> <code>R</code> package must be installed.</p>
<p>To do this, start up <code>R</code> using</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> R --vanilla</code></pre></div>
<p>Then, inside the <code>R</code> session, issue the command</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">&quot;ggplot2&quot;</span>))</code></pre></div>
<p>This will likely take a few minutes. To check that all is well, open the BETYdb app in a browser and navigate to the Data/Priors page. The images in the middle column should start being generated on the fly.</p>
</div>
<div id="step-26-ensure-the-schemaspy-documentation-can-be-generated" class="section level3 unnumbered">
<h3>Step 26: Ensure the SchemaSpy documentation can be generated</h3>
<p>SchemaSpy documentation is generated using Java. Two Jar files are needed, a PostgreSQL JDBC Driver file and a customized version of the SchemaSpy file. These need to be downloaded to a suitable location. By way of example, we’ll put them in <code>/var/www/betyapp/code/lib/tasks/jar</code>. To do this, first log in to the <code>betyappuser</code> account:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> -u betyappuser -H bash -l</code></pre></div>
<p>Then run the following commands:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> /var/www/betyapp/code/lib/tasks
<span class="fu">mkdir</span> jar
<span class="bu">cd</span> jar
<span class="fu">wget</span> https://www.dropbox.com/s/j50hk7cbqw7680u/schemaSpy.jar
<span class="fu">wget</span> https://jdbc.postgresql.org/download/postgresql-42.2.4.jar</code></pre></div>
<p>Here, we use the latest JDBC Driver file as of this writing, postgresql-42.2.4.jar.</p>
<p>Now, append to the <code>config/application.yml</code> configuration file as follows (be sure to use <code>&gt;&gt;</code> instead of <code>&gt;</code>):</p>
<pre><code>cat &gt;&gt; config/application.yml &lt;&lt; EOF

schema_spy_settings:
    java_executable: java
    postgresql_driver_jar_file: lib/tasks/jar/postgresql-42.2.4.jar
    settings_for_customized_documentation:
        schema_spy_jar_file: lib/tasks/jar/schemaSpy.jar
        output_directory: .
        remove_root_dir_files: true

EOF</code></pre>
<p>Run the <code>rake</code> task to generate the SchemaSpy documentation as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">bundle</span> exec rake bety:dbdocs RAILS_ENV=production</code></pre></div>
<p>Restart the Rails app with</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">touch</span> tmp/restart.txt</code></pre></div>
<p>and try visiting the database documentation in a browser by going to the URL for your running BETYdb instance and clicking the <code>Schema</code> menu item under the <code>Docs</code> menu.</p>
<p><strong>You should now have a fully-functional BETYdb instance.</strong></p>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="3">
<li id="fn3"><p>BETYdb will mostly run without R, dot, and Java. R is needed for generating preview images on the Priors pages. Java is needed in order to generate the database schema documentation, and dot is needed to generate diagrams for that documentation.<a href="deploying-a-production-copy-of-the-betydb-web-application.html#fnref3">↩</a></p></li>
<li id="fn4"><p>See the Phusion Passenger site’s instructions for installing Passenger here: <a href="https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/ownserver/apache/oss/el7/install_passenger.html" class="uri" target="_blank">https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/ownserver/apache/oss/el7/install_passenger.html</a><a href="deploying-a-production-copy-of-the-betydb-web-application.html#fnref4">↩</a></p></li>
<li id="fn5"><p>We don’t need to repeat all the options to <code>bundle install</code> that we used earlier because these options are “sticky”: they are stored in the bundle configuration file and will be used automatically until explicitly removed.<a href="deploying-a-production-copy-of-the-betydb-web-application.html#fnref5">↩</a></p></li>
<li id="fn6"><p>Unless otherwise noted, we use the word “schema” in its traditional sense, where it refers to the logical structure of a database, including the tables, views, functions, and integrity constraints it comprises. We are not using “schema” in its PostgreSQL-specific sense, where it refers to a namespace within a database.<a href="deploying-a-production-copy-of-the-betydb-web-application.html#fnref6">↩</a></p></li>
<li id="fn7"><p>If the Web site is to be served using SSL (Secure Sockets Layer), the virtual host directive should be <code>&lt;VirtualHost *:443&gt;</code>. Data providers that are particularly concerned about data security are advised to use SSL. If SSL is used, it is recommended to redirect calls to port 80 (http) to port 443 (https) using a directive such as the following:</p>
<pre><code>&lt;VirtualHost *:80&gt;
    ServerName yourserver.com
    Redirect permanent / https://yourserver.com
&lt;/VirtualHost&gt;</code></pre>
<p>or, for suburi deployments,</p>
<pre><code>&lt;VirtualHost *:80&gt;
    ServerName yourserver.com
    Redirect permanent /suburi https://yourserver.com/suburi
&lt;/VirtualHost&gt;</code></pre>
<p>This way, the site will always be served up securely.<a href="deploying-a-production-copy-of-the-betydb-web-application.html#fnref7">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="betydb-tables.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="setting-up-a-centos-server.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
